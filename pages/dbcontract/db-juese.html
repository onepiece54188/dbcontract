<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>角色管理</title>
    <!-- Favicon-->
    <link rel="icon" href="../../favicon.ico" type="image/x-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css">

    <!-- Bootstrap Core Css -->
    <link href="../../plugins/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Waves Effect Css -->
    <link href="../../plugins/node-waves/waves.css" rel="stylesheet" />

    <!-- Animation Css -->
    <link href="../../plugins/animate-css/animate.css" rel="stylesheet" />
	
	<!-- Sweetalert Css -->
    <!-- <link href="../../plugins/sweetalert/sweetalert.css" rel="stylesheet" /> -->

    <!-- JQuery DataTable Css -->
    <link href="../../plugins/jquery-datatable/skin/bootstrap/css/dataTables.bootstrap.css" rel="stylesheet">

    <!-- Custom Css -->
    <link href="../../css/style.css" rel="stylesheet">

    <!-- AdminBSB Themes. You can choose a theme from css/themes instead of get all themes -->
    <link href="../../css/themes/all-themes.css" rel="stylesheet" />
    
    <link href="../../sweetalert2-7.33.1/package/dist/sweetalert2.min.css" rel="stylesheet" />
</head>

<body class="theme-red">
    <!-- Page Loader -->
    <div class="page-loader-wrapper">
        <div class="loader">
            <div class="preloader">
                <div class="spinner-layer pl-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <p>Please wait...</p>
        </div>
    </div>
    <!-- #END# Page Loader -->
    <!-- Overlay For Sidebars -->
    <div class="overlay"></div>
    <!-- #END# Overlay For Sidebars -->

    <!-- Top Bar -->
    <nav class="navbar">
        <div class="container-fluid">
            <div class="navbar-header">
                <a href="javascript:void(0);" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false"></a>
                <a href="javascript:void(0);" class="bars"></a>
                <a class="navbar-brand" href="index.html">合同管理系统</a>
            </div>
			<div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li class="pull-right"><a href="sign-in.html" class=""><i class="material-icons">input</i></a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- #Top Bar -->
<section>
        <!-- Left Sidebar -->
        <aside id="leftsidebar" class="sidebar">
            <!-- User Info -->            <!-- #User Info -->
            <!-- Menu -->
            <div class="menu" id="menu">
                <ul class="list">
                    <li class="header">功能列表</li>
                    
                    <li v-if="liucheng">
                        <a href="javascript:void(0);" class="menu-toggle">
                            <i class="material-icons">trending_down</i>
                            <span>流程管理</span>
                        </a>
                        <ul class="ml-menu">
                            <li v-if="data.can_write_contracts">
                                <a href="db-qicao.html">
                                    <span>起草合同</span>
                                </a>
                            </li>
							<li v-if="data.can_countersign">
                                <a href="db-huiqian.html">
                                    <span>会签合同</span>
                                </a>
                            </li>
							<li v-if="data.can_write_contracts">
                                <a href="db-dinggao.html">
                                    <span>定稿合同</span>
                                </a>
                            </li>
							<li v-if="data.can_review">
                                <a href="db-shenpi.html">
                                    <span>审批合同</span>
                                </a>
                            </li>
							<li v-if="data.can_sign">
                                <a href="db-qianding.html">
                                    <span>签订合同</span>
                                </a>
                            </li>
                        </ul>
                    </li>
					<li v-if="xinxi">
                        <a href="javascript:void(0);" class="menu-toggle">
                            <i class="material-icons">event_note</i>
                            <span>信息管理</span>
                        </a>
                        <ul class="ml-menu">
                            <li v-if="data.can_read_contracts">
                                <a href="db-chaxun.html">
                                    <span>合同查询</span>
                                </a>
                            </li>
							<li v-if="data.can_manage_clients">
                                <a href="db-kehu.html">
                                    <span>客户管理</span>
                                </a>
                            </li>
                        </ul>
                    </li>
					<li v-if="xitong">
                        <a href="javascript:void(0);" class="menu-toggle">
                            <i class="material-icons">settings</i>
                            <span>系统管理</span>
                        </a>
                        <ul class="ml-menu">
                            <li v-if="data.can_distribute">
                                <a href="db-fenpei.html">
                                    <span>合同分配</span>
                                </a>
                            </li>
							<li v-if="data.can_manage_users">
                                <a href="db-yonghu.html">
                                    <span>用户管理</span>
                                </a>
                            </li>
							<li v-if="data.can_manage_roles">
                                <a href="db-juese.html">
                                    <span>角色管理</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!-- #Menu -->
            <!-- Footer -->
            <div class="legal">
                <div class="copyright">
                    &copy; 2018 - 2019 <a href="javascript:void(0);">合同管理系统</a>.
                </div>
                <div class="version">
                    <b>Version: </b> 1.0.0
                </div>
            </div>
            <!-- #Footer -->
        </aside>
        <!-- #END# Left Sidebar -->
    </section>

    <section class="content">
        <div class="container-fluid">
            <!-- Basic Examples -->
            <div class="row clearfix">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="card">
                        <div class="header">
                            <h2>
                                角色管理
                            </h2>
                            <ul class="header-dropdown m-r--5">
                                <li class="dropdown">
                                    <a href="javascript:void(0);" onclick="addRole()">
                                        <i class="material-icons">add</i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="body">
                            <div class="table-responsive" id="vue">
                                <table class="table table-striped table-hover js-basic-example dataTable">
                                    <thead>
                                        <tr>
                                            <th>序号</th>
                                            <th>名称</th>
                                            <th>起草/定稿</th>
                                            <th>会签</th>
                                            <th>审批</th>
											<th>签定</th>
											<th>合同查询</th>
											<th>客户管理</th>
											<th>流程分配</th>
											<th>用户管理</th>
											<th>角色管理</th>
											<th>操 作</th>
                                        </tr>
                                    </thead>
									<tbody>
										<template v-for="i in d">
											<tr>
                        						<td>{{ i.id }}</td>
												<td>{{ i.name }}</td>
												<td>{{ i.can_write_contracts }}</td>
												<td>{{ i.can_countersign }}</td>
												<td>{{ i.can_review }}</td>
												<td>{{ i.can_sign }}</td>
												<td>{{ i.can_read_contracts }}</td>
												<td>{{ i.can_manage_clients }}</td>
												<td>{{ i.can_distribute }}</td>
												<td>{{ i.can_manage_users }}</td>
												<td>{{ i.can_manage_roles }}</td>
												<td class="row">
													<div class="btn-group btn-group-xs js-sweetalert" role="group" aria-label="Extra-small button group">
														<button type="button" @click="update(i.id,i.name,i.can_write_contracts,i.can_countersign,i.can_review,i.can_sign,i.can_read_contracts,i.can_manage_clients,i.can_distribute,i.can_manage_users,i.can_manage_roles)" class="btn bg-amber waves-effect">修改角色</button>
                            <button type="button" @click="delete1(i.id,i.name)" class="btn bg-red waves-effect">删 除</button>
													</div>
												</td>
											</tr>
										</template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- #END# Basic Examples -->
        </div>
    </section>

    <!-- Jquery Core Js -->
    <script src="../../plugins/jquery/jquery.min.js"></script>
	
    <!-- Vue -->
    <script src="../../js/vue.min.js"></script>
    <script src="../../js/vue-resource.min.js"></script>
	
	<script>
		
//		if(typeof(localStorage.theme)!="undefined"){
//			$('body').removeClass($('body').prop("className"));
//			$('body').addClass(localStorage.theme);
//		}

  function sc(){
    // 重载js
    $.getScript('https://totalwar.oss-cn-beijing.aliyuncs.com/static/js/admin.js',function(){});
  };
  function addRole(){
    Swal({
      html:
        '<div class="form-group">'+
        '<label style="float:left;font-size:18px;" class="form-label">名称:</label>'+
        '<div class="form-line"><input type="text" class="form-control" id="name1" name="name" placeholder="请输入名称" required></div></div>' +
        '<div class="demo-checkbox">'+
        '<input type="checkbox" id="md_checkbox_21" class="filled-in chk-col-red" />'+
        '<label for="md_checkbox_21">起草合同</label>'+
        '<input type="checkbox" id="md_checkbox_22" class="filled-in chk-col-pink" />'+
        '<label for="md_checkbox_22">会签合同</label>'+
        '<input type="checkbox" id="md_checkbox_23" class="filled-in chk-col-purple" />'+
        '<label for="md_checkbox_23">审批合同</label>'+
        '<input type="checkbox" id="md_checkbox_24" class="filled-in chk-col-deep-purple" />'+
        '<label for="md_checkbox_24">签订合同</label>'+
        '<input type="checkbox" id="md_checkbox_25" class="filled-in chk-col-indigo" />'+
        '<label for="md_checkbox_25">查询合同</label>'+
        '<input type="checkbox" id="md_checkbox_26" class="filled-in chk-col-blue" />'+
        '<label for="md_checkbox_26">客户管理</label>'+
        '<input type="checkbox" id="md_checkbox_27" class="filled-in chk-col-light-blue" />'+
        '<label for="md_checkbox_27">合同分配</label>'+
        '<input type="checkbox" id="md_checkbox_28" class="filled-in chk-col-cyan" />'+
        '<label for="md_checkbox_28">用户管理</label>'+
        '<input type="checkbox" id="md_checkbox_29" class="filled-in chk-col-teal" />'+
        '<label for="md_checkbox_29">角色管理</label>'+
        '</div>',
      <!-- onBeforeOpen: () => { -->
        <!-- if(can_write_contracts) -->
          <!-- $("#md_checkbox_21").prop("checked",'+can_write_contracts+'); -->
        <!-- if(can_countersign) -->
          <!-- $("#md_checkbox_22").prop("checked",'+can_countersign+'); -->
        <!-- if(can_review) -->
          <!-- $("#md_checkbox_23").prop("checked",'+can_review+'); -->
        <!-- if(can_sign) -->
          <!-- $("#md_checkbox_24").prop("checked",'+can_sign+'); -->
        <!-- if(can_read_contracts) -->
          <!-- $("#md_checkbox_25").prop("checked",'+can_read_contracts+'); -->
        <!-- if(can_manage_clients) -->
          <!-- $("#md_checkbox_26").prop("checked",'+can_manage_clients+'); -->
        <!-- if(can_distribute) -->
          <!-- $("#md_checkbox_27").prop("checked",'+can_distribute+'); -->
        <!-- if(can_manage_users) -->
          <!-- $("#md_checkbox_28").prop("checked",'+can_manage_users+'); -->
        <!-- if(can_manage_roles) -->
          <!-- $("#md_checkbox_29").prop("checked",'+can_manage_roles+'); -->
      <!-- }, -->
      confirmButtonText: '添加',
      cancelButtonText: '取消',
      focusConfirm: false,
      showCancelButton: true,
    }).then((result)=>{
      can_write_contracts1 = $("#md_checkbox_21").prop("checked");
      can_countersign1 = $("#md_checkbox_22").prop("checked");
      can_review1 = $("#md_checkbox_23").prop("checked");
      can_sign1 = $("#md_checkbox_24").prop("checked");
      can_read_contracts1 = $("#md_checkbox_25").prop("checked");
      can_manage_clients1 = $("#md_checkbox_26").prop("checked");
      can_distribute1 = $("#md_checkbox_27").prop("checked");
      can_manage_users1 = $("#md_checkbox_28").prop("checked");
      can_manage_roles1 = $("#md_checkbox_29").prop("checked");
      
      nameInfo = document.getElementById("name1").value;
      const swalWithBootstrapButtons = Swal.mixin({
        confirmButtonClass: 'btn btn-success',
        cancelButtonClass: 'btn btn-danger',
        buttonsStyling: true,
      })
      swalWithBootstrapButtons({
        title: '确定添加么',
        type: 'warning',
        showCancelButton: true,
        confirmButtonText: '是, 添加',
        cancelButtonText: '否, 取消',
        focusConfirm: false,
        reverseButtons: false
      }).then((result) => {
        if (result.value) {
          console.log('yes');
          Vue.http.post('http://149.248.21.145:8000/roles/',
            {
              name:nameInfo,
              can_write_contracts:can_write_contracts1,
              can_countersign:can_countersign1,
              can_review:can_review1,
              can_sign:can_sign1,
              can_read_contracts:can_read_contracts1,
              can_manage_clients:can_manage_clients1,
              can_distribute:can_distribute1,
              can_manage_users:can_manage_users1,
              can_manage_roles:can_manage_roles1
            }
          ).then(function(res){
            swalWithBootstrapButtons(
            '已添加!',
            ).then((result) => {
              location=location;
            })
          })
        } else if (
          // Read more about handling dismissals
          result.dismiss === Swal.DismissReason.cancel
        ) {
          swalWithBootstrapButtons(
            '已取消',
          )
        }
      })
    })
  }
	</script>
	
	<script>
		var role = sessionStorage.role;
		var permission = new Vue({
			el:'#menu',
			data: {
				liucheng: false,
				xinxi: false,
				xitong: false,
				data:{
					id: '',
					name: '',
					can_read_contracts: false,
					can_write_contracts: false,
					can_countersign: false,
					can_review: false,
					can_sign: false,
					can_distribute: false,
					can_manage_users: false,
					can_manage_roles: false,
					can_manage_clients: false
				}
			},
			methods: {
				get: function(){
					// test role
					 //role = 2;
					if(role!=null) {
						//发送 post 请求
						
						$.ajax({
							type: "GET",
							url: 'http://149.248.21.145:8000/roles/'+role+'/',
							dataType: "json",
							async: false,
							success: function(res){
								console.log(res);
								permission.liucheng = true;
								permission.xinxi = true;
								permission.xitong = true;
								permission.data=res;
								sessionStorage.allPermission = JSON.stringify(permission.data);
								console.log(permission.data);
								//sc();
							},
							
						});
//						this.$http.get('http://149.248.21.145:8000/roles/'+role+'/').then(function(res){
//							this.liucheng = true;
//							this.xinxi = true;
//							this.xitong = true;
//							this.data=res.body;
//              sessionStorage.allPermission = JSON.stringify(this.data);
//              /*var obj = JSON.parse(sessionStorage.allPermission);
//              console.log(obj.can_read_contracts);测试session如何存储对象*/
//							sc();
//						},function(res){
//							console.log(res);
//						});
					}
				},
			}
		});
		
		permission.get();
		
		var table = new Vue({
			el: "#vue",
			data: {
				d: [],
			},
			methods: {
				get: function() {
					$.ajax({
						type: "GET",
						url: 'http://149.248.21.145:8000/roles',
						dataType: "json",
						async: false,
						success: function(res){
							console.log(res);
							table.d=res;
						},
					});
				},
        update: async function(id, name,can_write_contracts,can_countersign,can_review,can_sign,can_read_contracts,can_manage_clients,can_distribute,can_manage_users,can_manage_roles) {
          const {value: accept} = await Swal({
            title: '修改角色',
            html:
              '<div class="form-group">'+
              '<label style="float:left;font-size:18px;" class="form-label">名称:</label>'+
              '<div class="form-line"><input type="text" class="form-control" id="name1" name="name" value="'+name+'" required></div></div>' +
              '<div class="demo-checkbox">'+
              '<input type="checkbox" id="md_checkbox_21" class="filled-in chk-col-red" />'+
              '<label for="md_checkbox_21">起草合同</label>'+
              '<input type="checkbox" id="md_checkbox_22" class="filled-in chk-col-pink" />'+
              '<label for="md_checkbox_22">会签合同</label>'+
              '<input type="checkbox" id="md_checkbox_23" class="filled-in chk-col-purple" />'+
              '<label for="md_checkbox_23">审批合同</label>'+
              '<input type="checkbox" id="md_checkbox_24" class="filled-in chk-col-deep-purple" />'+
              '<label for="md_checkbox_24">签订合同</label>'+
              '<input type="checkbox" id="md_checkbox_25" class="filled-in chk-col-indigo" />'+
              '<label for="md_checkbox_25">查询合同</label>'+
              '<input type="checkbox" id="md_checkbox_26" class="filled-in chk-col-blue" />'+
              '<label for="md_checkbox_26">客户管理</label>'+
              '<input type="checkbox" id="md_checkbox_27" class="filled-in chk-col-light-blue" />'+
              '<label for="md_checkbox_27">合同分配</label>'+
              '<input type="checkbox" id="md_checkbox_28" class="filled-in chk-col-cyan" />'+
              '<label for="md_checkbox_28">用户管理</label>'+
              '<input type="checkbox" id="md_checkbox_29" class="filled-in chk-col-teal" />'+
              '<label for="md_checkbox_29">角色管理</label>'+
              '</div>',
            onBeforeOpen: () => {
              if(can_write_contracts)
                $("#md_checkbox_21").prop("checked",'+can_write_contracts+');
              if(can_countersign)
                $("#md_checkbox_22").prop("checked",'+can_countersign+');
              if(can_review)
                $("#md_checkbox_23").prop("checked",'+can_review+');
              if(can_sign)
                $("#md_checkbox_24").prop("checked",'+can_sign+');
              if(can_read_contracts)
                $("#md_checkbox_25").prop("checked",'+can_read_contracts+');
              if(can_manage_clients)
                $("#md_checkbox_26").prop("checked",'+can_manage_clients+');
              if(can_distribute)
                $("#md_checkbox_27").prop("checked",'+can_distribute+');
              if(can_manage_users)
                $("#md_checkbox_28").prop("checked",'+can_manage_users+');
              if(can_manage_roles)
                $("#md_checkbox_29").prop("checked",'+can_manage_roles+');
            },
            confirmButtonText: '更改',
            cancelButtonText: '取消',
            focusConfirm: false,
            showCancelButton: true,
          }).then((result)=>{
            can_write_contracts1 = $("#md_checkbox_21").prop("checked");
            can_countersign1 = $("#md_checkbox_22").prop("checked");
            can_review1 = $("#md_checkbox_23").prop("checked");
            can_sign1 = $("#md_checkbox_24").prop("checked");
            can_read_contracts1 = $("#md_checkbox_25").prop("checked");
            can_manage_clients1 = $("#md_checkbox_26").prop("checked");
            can_distribute1 = $("#md_checkbox_27").prop("checked");
            can_manage_users1 = $("#md_checkbox_28").prop("checked");
            can_manage_roles1 = $("#md_checkbox_29").prop("checked");
            
            nameInfo = document.getElementById("name1").value;
            const swalWithBootstrapButtons = Swal.mixin({
              confirmButtonClass: 'btn btn-success',
              cancelButtonClass: 'btn btn-danger',
              buttonsStyling: true,
            })
            swalWithBootstrapButtons({
              title: '确定更改么',
              text: "更改后不可恢复！",
              type: 'warning',
              showCancelButton: true,
              confirmButtonText: '是, 更改',
              cancelButtonText: '否, 取消',
              focusConfirm: false,
              reverseButtons: false
            }).then((result) => {
              if (result.value) {
                console.log('yes');
                this.$http.patch('http://149.248.21.145:8000/roles/'+id+'/',
                  {
                    name:nameInfo,
                    can_write_contracts:can_write_contracts1,
                    can_countersign:can_countersign1,
                    can_review:can_review1,
                    can_sign:can_sign1,
                    can_read_contracts:can_read_contracts1,
                    can_manage_clients:can_manage_clients1,
                    can_distribute:can_distribute1,
                    can_manage_users:can_manage_users1,
                    can_manage_roles:can_manage_roles1
                  }
                ).then(function(res){
                  swalWithBootstrapButtons(
                  '已更改!',
                  '该角色已被更改',
                  'success'
                  ).then((result) => {
                    location=location;
                  })
                })
              } else if (
                // Read more about handling dismissals
                result.dismiss === Swal.DismissReason.cancel
              ) {
                swalWithBootstrapButtons(
                  '已取消',
                  '角色未被更改',
                  'error'
                )
              }
            })
          })

        },
        delete1: function(id, name) {
          const swalWithBootstrapButtons = Swal.mixin({
            confirmButtonClass: 'btn btn-success',
            cancelButtonClass: 'btn btn-danger',
            buttonsStyling: true,
          })

          swalWithBootstrapButtons({
            title: '确定删除'+name+'角色么',
            text: "删除后不可恢复！",
            type: 'warning',
            showCancelButton: true,
            confirmButtonText: '是, 删除',
            cancelButtonText: '否, 取消',
            reverseButtons: false
          }).then((result) => {
            if (result.value) {
              console.log('yes');
              this.$http.delete('http://149.248.21.145:8000/roles/'+id+'/').then(function(res){
                swalWithBootstrapButtons(
                  '已删除!',
                  '该角色已被删除',
                  'success'
                ).then((result) => {
                  location=location;
                })
              })
            } else if (
              // Read more about handling dismissals
              result.dismiss === Swal.DismissReason.cancel
            ) {
            
              console.log('no');
              swalWithBootstrapButtons(
                '已取消',
                '角色未被删除',
                'error'
              )
            }
          })
        }
      }
    });
		table.get();
		
	</script>
	
	<!-- Bootstrap Core Js -->
    <script src="../../plugins/bootstrap/js/bootstrap.js"></script>

    <!-- Select Plugin Js -->
    <script src="../../plugins/bootstrap-select/js/bootstrap-select.js"></script>

    <!-- Slimscroll Plugin Js -->
    <script src="../../plugins/jquery-slimscroll/jquery.slimscroll.js"></script>

    <!-- Waves Effect Plugin Js -->
    <script src="../../plugins/node-waves/waves.js"></script>
    <!-- SweetAlert 2 -->
    <script src="../../sweetalert2-7.33.1/package/dist/sweetalert2.all.js"></script>

    <!-- Jquery DataTable Plugin Js -->
    <script src="../../plugins/jquery-datatable/jquery.dataTables.js"></script>
    <script src="../../plugins/jquery-datatable/skin/bootstrap/js/dataTables.bootstrap.js"></script>
    <script src="../../plugins/jquery-datatable/extensions/export/dataTables.buttons.min.js"></script>
    <script src="../../plugins/jquery-datatable/extensions/export/buttons.flash.min.js"></script>
    <script src="../../plugins/jquery-datatable/extensions/export/jszip.min.js"></script>
    <script src="../../plugins/jquery-datatable/extensions/export/pdfmake.min.js"></script>
    <script src="../../plugins/jquery-datatable/extensions/export/vfs_fonts.js"></script>
    <script src="../../plugins/jquery-datatable/extensions/export/buttons.html5.min.js"></script>
    <script src="../../plugins/jquery-datatable/extensions/export/buttons.print.min.js"></script>

    <!-- Custom Js -->
    <script src="../../js/admin.js"></script>
    <script src="../../js/pages/tables/jquery-datatable.js"></script>

    <!-- Demo Js -->
    <script src="../../js/demo.js"></script>
</body>

</html>
